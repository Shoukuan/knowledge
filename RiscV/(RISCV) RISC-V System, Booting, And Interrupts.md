# (RISCV) RISC-V System, Booting, And Interrupts

[(RISCV) RISC-V System, Booting, And Interrupts](https://marz.utk.edu/my-courses/cosc562/riscv/)

## RISC-V CPU 寄存器
### 整数寄存器（32 个）
RISC-V 的 32 个整数寄存器（x0-x31）通过 ABI 名称（Application Binary Interface）定义其约定用途：

| 寄存器 | ABI名称  | 描述   |
| :----:| :----:  | :----: |
|  x0 |    zero      | 0      |
|  x1 |     ra    |返回地址：保存函数调用后的返回地址（如 call 指令会自动写入 ra） |
|  x2 |      sp   |栈指针：指向当前栈顶，需按 16 字节对齐（RISC-V 硬性要求）   |
|  x3 |    gp      |全局指针：指向全局数据区（非必需，由工具链决定是否使用） |
|  x4 |    tp      |线程指针：指向线程局部存储（TLS）的基地址 |
|  x5-x7<br>x28-x31 |   t0-t6  |临时寄存器：调用者保存（Caller-saved）。用于临时计算，函数调用后值可能被覆盖 |
|  x8-x9<br>x18-x27 |   s0-s11  |保留寄存器：被调用者保存（Callee-saved）。若需使用，需在函数开头保存，结尾恢复 |
|  x10-x17 |   a0-a7  |参数/返回值寄存器：<br>- a0-a1：保存函数返回值<br>- a0-a7：传递前 8 个参数 |

### 关键寄存器用途详解
1. 调用约定相关
a0-a7：传递函数参数，超出 8 个的参数通过栈传递（参考 C 语言调用约定）。
ra：函数返回地址，若函数内调用其他函数（如嵌套调用），需手动保存 ra 到栈。
sp：栈指针，必须按 16 字节对齐（违反会导致异常）。函数调用时需调整栈空间。
2. 临时与保留寄存器
临时寄存器（t0-t6）：
调用者（Caller）需在调用函数前保存这些寄存器的值（若后续需要复用）。
保留寄存器（s0-s11）：
被调用者（Callee）需在使用前保存到栈，并在返回前恢复原值。
3. 特殊寄存器
zero：常用于快速清零或条件判断，例如：
beq a0, zero, label  # 若 a0 == 0，跳转到 label
add a1, a2, zero     # a1 = a2 + 0（等效于 a1 = a2）
gp：优化全局变量访问，工具链可能用它指向全局数据区，减少 lui 指令的使用。
tp：用于线程局部存储（TLS），操作系统或运行时库通过它访问线程私有数据。


## RISC-V 指令集

| 指令 | 描述 |
| :----: | :----: |
| addi | 将立即数加到寄存器 |
| lw | 从内存加载数据到寄存器 |
| sw | 从寄存器存储数据到内存 |
| jalr | 跳转到寄存器中的地址并返回 |
| ecall | 调用系统调用 |
| ebreak | 断点 |

## RISC-V 系统调用

| 系统调用 | 描述 |
| :----: | :----: |
| 0 | 打印字符串 |
| 1 | 打印整数 |
| 2 | 打印浮点数 |
| 3 | 退出程序 |
| 4 | 读取字符串 |
| 5 | 读取整数 |
| 6 | 读取浮点数 |
| 7 | 退出程序并返回状态码 |
| 8 | 打开文件 |
| 9 | 读取文件 |
| 10 | 写入文件 |
| 11 | 关闭文件 |

```C
li a7, 64       # 系统调用号（如 Linux 的 write 调用号为 64）
li a0, 1        # 参数1：文件描述符（标准输出）
la a1, buffer   # 参数2：缓冲区地址
li a2, 12       # 参数3：数据长度
ecall           # 触发系统调用
```

异常编码（mcause/scause）	名称	触发场景
0	指令地址未对齐	jalr或分支指令跳转到非对齐地址
1	指令访问错误	取指时内存权限或物理地址无效
2	非法指令	解码到未定义的指令编码
3	断点触发	执行ebreak或调试器断点
4	加载地址未对齐	加载（Load）操作地址非对齐
5	加载访问错误	加载时内存权限或物理地址无效
6	存储/AMO地址未对齐	存储（Store）或原子操作地址非对齐
7	存储/AMO访问错误	存储或原子操作时内存权限或物理地址无效
8	用户模式环境调用	执行ecall（在U模式下）
9	监督者模式环境调用	执行ecall（在S模式下）
11	机器模式环境调用	执行ecall（在M模式下）
12+	其他保留或自定义异常	由具体实现定义（如浮点异常、自定义扩展异常）

mtvec/stvec：陷阱向量基地址（支持直接模式或向量模式）。
mepc/sepc：异常返回地址（指向触发异常的指令或下一条指令）。
mcause/scause：异常原因编码（最高位为0表示异常，1表示中断）。
mtval/stval：附加信息（如未对齐地址、非法指令编码）。
mstatus/sstatus：全局状态（如中断使能位、特权模式记录）。